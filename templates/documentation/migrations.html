{% extends "documentation/index.html" %}

{% block title %}Documentation | Migrations{% endblock %}

{% block style-before %}
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/lib/prettify.css"/>
{% endblock %}

{% block script %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/lib/prettify.js"></script>
    <script type="text/javascript">
        $(document).observe("dom:loaded", function() {
            prettyPrint();
        })
    </script>
{% endblock %}

{% block content %}
    <article>
        <div class="a-content">
            <header>
                <p class="lead">Migrations</p>
            </header>

            <p>
                Noboy is perfect. Even developers.
            </p>

            <p>
                In every project change happens. Old models need to be updated and new ones need to be added. The latter is not much of a  problem, as androrm simply recognizes your new models and creates new tables for them. The same does not hold, if you add fields to your existing models. To save time, androrm won't check each time if something has changed on your models and perform the respective updates. In the past that meant you needed to manually drop the table and have it recreated by androrm. We all knew that this is not particularly good. To overcome this issue, we introduce <em>migrations</em>. This page will teach you how to update your model classes with ease.
            </p>

            <hr />

            <section>
                <header>
                    <p class="lead">
                        <a name="basics" href="#basics">The Basics</a>
                    </p>
                </header>

                <p>
                    In order to run any migration on one of your models, you need to override the <code>migrate</code> method of the <code>Model</code> class. This method will be called after androrm has initialized all the models and is used to run any kind of migration. The following example shows you, how an empty <code>migrate</code> method would look like.
                </p>

                <pre class="prettyprint linenums">{% include "documentation/examples/models/migrations/basic.java" %}</pre>

                <p>
                    The <code>context</code> instance you need to hand to the method will later be used to roll out all migrations.
                </p>

            </section>

            <hr />

            <section>
                <header>
                    <p class="lead">
                        <a name="adding_data_fields" href="#adding_data_fields">Adding Fields</a>
                    </p>
                </header>

                <p>
                    In most cases you have defined a model with some fields on it. We did so with the <code>Author</code> model. Currently, only a name can be assigned to an author. But maybe this author also wrote some book using a synonym. So first up, we add this new field to the model itself.
                </p>

                <pre class="prettyprint linenums">{% include "documentation/examples/models/migrations/field_no_migration.java" %}</pre>

                <p>
                    So far, so good. The problem here is that androrm can not detect, that the signature of the table has changed and that a new field should be added. You need to help out a little bit. Using a <code>Migrator</code> instance, we will tell androrm what to do.
                </p>

                <pre class="prettyprint linenums">{% include "documentation/examples/models/migrations/field_migration.java" %}</pre>

                <p>
                    Using the <code>migrator</code> we can run several migrations on the model. The good thing here is that androrm will keep track of the migrations, you have already rolled out and if they are necessary. So if your code runs on a fresh install were everything is right in place from minute one, no migrations will be run, and if it runs on an old installation the migrations will be applied.
                </p>

                <p>
                    What is important to mention, is that you should not remove migrations. All migrations, that you have applied to get from the first version of your model, to your current one should remain in the <code>migrate</code> method. This will make sure that everybody who is using your app will work on the same data scheme.
                </p>

            </section>

            <hr />

            <section>

                <header>
                    <p class="lead">
                        <a name="renaming_models" href="#renaming_models">Renaming Models</a>
                    </p>
                </header>

                <p>
                    If you renamed one of your model classes you run into one big problem. Even though androrm recognizes the new class it will only create a new, empty table for it. With migrations you can now simply tell androrm that you have renamed one of your tables and it will make sure that all of your previous data is right in place.
                </p>

                <pre class="prettyprint linenums">{% include "documentation/examples/models/migrations/rename_model.java" %}</pre>

                <p>
                    As you might have noticed one small error occurred while I was writing this document :) Unfortunately I misspelled <code>Author</code>. To get rid of that mistake we will now apply a migration to rename the existing table for the model <code>Authro</code> to the correct value <code>Author</code>. To do so, wenn call <code>renameModel</code> on the <code>migrator</code> instance, tell it the name of the old model and hand in the <code>class</code> of the new one.
                </p>

            </section>

        </div>
    </article>

{% endblock %}

{% block menu_content %}
    <li>
        <a href="{% url documentation_index %}">Documentation</a>
    </li>
    <ul>
        <li>
            <a name="basics" href="#basics">The Basics</a>
        </li>
        <li>
            <a href="#adding_data_fields">Adding Data Fields</a>
        </li>
        <li>
            <a href="#renaming_models">Renaming Models</a>
        </li>
    </ul>
{% endblock %}